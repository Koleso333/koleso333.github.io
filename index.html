<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Koleso Dev</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="style.css">

    <style>
        /* ===== ЗАГРУЗЧИК / ЧЁРНЫЙ ЭКРАН ===== */

        /* Прячем основной контент, пока body.loading */
        body.loading .site-header,
        body.loading .page,
        body.loading .footer {
            visibility: hidden;
        }

        /* Чёрный экран / лоадер поверх всего */
        .app-loader {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            text-align: center;
            padding: 1.5rem;
        }

        /* Когда загрузились данные — прячем лоадер */
        body:not(.loading) .app-loader {
            display: none;
        }

        .loader-error {
            max-width: 420px;
            line-height: 1.4;
            font-size: 15px;
            opacity: 0.9;
        }

        /* ===== ПЕРЕКЛЮЧАТЕЛЬ 18+ ДЛЯ ИГР ===== */

        .games-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .games-adult-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 13px;
            opacity: 0.85;
            white-space: nowrap;
        }

        .games-adult-label {
            user-select: none;
        }

        /* Базовый переключатель */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background-color: #666;
            transition: 0.2s;
            border-radius: 999px;
        }

        .switch-slider::before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            top: 2px;
            background-color: #fff;
            transition: 0.2s;
            border-radius: 50%;
        }

        .switch input:checked + .switch-slider {
            background-color: #e53935; /* красный, 18+ */
        }

        .switch input:checked + .switch-slider::before {
            transform: translateX(20px);
        }

        /* Скрытые 18+ игры */
        .game-card--hidden-adult {
            display: none !important;
        }

        @media (max-width: 600px) {
            .games-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body class="loading">
<!-- Чёрный экран до загрузки JSON -->
<div id="app-loader" class="app-loader">
    Загрузка...
</div>

<header class="site-header" id="top">
    <div class="header-inner">
        <div class="brand">
            <div class="hero">
                <div class="hero-square hero-square--left"></div>
                <div class="hero-square hero-square--right"></div>
                <h1 class="hero-title">Koleso</h1>
            </div>

            <p class="brand-subtitle">
                личный хаб игр, саундтреков и прочих штук
            </p>
        </div>

        <nav class="nav" id="nav">
            <!-- дефолтные пункты (перезапишутся из JSON) -->
            <a href="#about" class="nav-link">Обо мне</a>
            <a href="#games" class="nav-link">Игры</a>
            <a href="#news" class="nav-link">Саундтреки</a>
            <a href="#news" class="nav-link">Новости</a>
            <a href="#contacts" class="nav-link">Контакты</a>
        </nav>
    </div>
</header>

<main class="page">

    <!-- ОБО МНЕ -->
    <section id="about" class="section card observe" data-section>
        <h2 class="section-title" id="about-title"></h2>
        <p class="section-text" id="about-text"></p>
    </section>

    <!-- ИГРЫ -->
    <section id="games" class="section card observe" data-section>
        <div class="games-header">
            <h2 class="section-title" id="games-title"></h2>

            <!-- переключатель 18+ справа от заголовка -->
            <div class="games-adult-toggle">
                <span class="games-adult-label">Показать 18+</span>
                <label class="switch">
                    <input type="checkbox" id="toggle-18plus">
                    <span class="switch-slider"></span>
                </label>
            </div>
        </div>

        <p class="section-text" id="games-text"></p>

        <div class="games-grid" id="games-grid">
            <!-- карточки игр подставятся из JSON -->
        </div>
    </section>

    <!-- НОВОСТИ -->
    <section id="news" class="section card observe" data-section>
        <h2 class="section-title" id="news-title"></h2>

        <div class="news-list" id="news-list">
            <!-- сюда JS подставит новости -->
        </div>
    </section>

    <!-- КОНТАКТЫ -->
    <section id="contacts" class="section card observe" data-section>
        <h2 class="section-title" id="contacts-title"></h2>
        <ul class="contacts-list" id="contacts-list">
            <!-- контакты подставятся из JSON -->
        </ul>
    </section>
</main>

<footer class="footer">
    <span>© <span id="year"></span> Koleso</span>
</footer>

<script>
    (function () {
        // ===== Общие вещи: анимация секций, год в подвале =====
        const sections = document.querySelectorAll('[data-section]');

        if ('IntersectionObserver' in window) {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('section--visible');
                    }
                });
            }, {
                threshold: 0.35
            });

            sections.forEach(section => observer.observe(section));
        } else {
            // Без поддержки IntersectionObserver просто показываем секции
            sections.forEach(section => section.classList.add('section--visible'));
        }

        // Год в подвале
        const yearEl = document.getElementById('year');
        if (yearEl) {
            yearEl.textContent = new Date().getFullYear();
        }

        const newsContainer  = document.getElementById('news-list');
        const gamesContainer = document.getElementById('games-grid');
        const adultToggle    = document.getElementById('toggle-18plus');

        const ADULT_TOGGLE_KEY = 'gamesShow18Plus';
        let showAdultGames = false;

        // ===== Работа с localStorage для 18+ =====
        function getSavedAdultToggle() {
            try {
                return localStorage.getItem(ADULT_TOGGLE_KEY);
            } catch (e) {
                return null;
            }
        }

        function setSavedAdultToggle(value) {
            try {
                localStorage.setItem(ADULT_TOGGLE_KEY, value);
            } catch (e) {
                // игнорируем ошибки (например, в приватном режиме)
            }
        }

        function applyAdultFilterToGames() {
            if (!gamesContainer) return;
            const cards = gamesContainer.querySelectorAll('.game-card');
            cards.forEach(card => {
                const isAdult = card.dataset.adult === 'true';
                if (isAdult && !showAdultGames) {
                    card.classList.add('game-card--hidden-adult');
                } else {
                    card.classList.remove('game-card--hidden-adult');
                }
            });
        }

        function onAdultToggleChange(e) {
            const checked = e.target.checked;

            // Включение 18+ — показать предупреждение
            if (checked && !showAdultGames) {
                const ok = window.confirm(
                    'Эта настройка покажет игры с контентом 18+.\n' +
                    'Подтвердите, что вам уже есть 18 лет.'
                );
                if (!ok) {
                    e.target.checked = false;
                    return;
                }
            }

            showAdultGames = checked;
            setSavedAdultToggle(showAdultGames ? '1' : '0');
            applyAdultFilterToGames();
        }

        // Инициализация состояния переключателя 18+ из localStorage
        if (adultToggle) {
            const saved = getSavedAdultToggle();
            showAdultGames = saved === '1';
            adultToggle.checked = showAdultGames;
            adultToggle.addEventListener('change', onAdultToggleChange);
        }

        // ====== CONTENT.JSON (критичный JSON) ======
        async function loadContentJson() {
            const res = await fetch('content/content.json', { cache: 'no-cache' });
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();
            applyContent(data);
        }

        function applyContent(data) {
            // Title
            if (data.meta && data.meta.title) {
                document.title = data.meta.title;
            }

            // Шапка
            const heroTitleEl = document.querySelector('.hero-title');
            const brandSubtitleEl = document.querySelector('.brand-subtitle');

            if (data.brand) {
                if (data.brand.heroTitle && heroTitleEl) {
                    heroTitleEl.textContent = data.brand.heroTitle;
                }
                if (data.brand.subtitle && brandSubtitleEl) {
                    brandSubtitleEl.textContent = data.brand.subtitle;
                }
            }

            // Навигация
            const navEl = document.getElementById('nav');
            if (navEl && Array.isArray(data.nav)) {
                navEl.innerHTML = '';
                data.nav.forEach(item => {
                    const a = document.createElement('a');
                    a.className = 'nav-link';
                    a.href = '#' + item.id;
                    a.textContent = item.label;
                    navEl.appendChild(a);
                });
            }

            // Секции (любые id из data.sections)
            if (data.sections) {
                Object.entries(data.sections).forEach(([id, sec]) => {
                    const titleEl = document.getElementById(id + '-title');
                    const textEl  = document.getElementById(id + '-text');

                    if (titleEl && sec && sec.title) {
                        titleEl.textContent = sec.title;
                    }
                    if (textEl && sec) {
                        if (sec.html) textEl.innerHTML = sec.html;
                        else if (sec.text) textEl.textContent = sec.text;
                        else textEl.textContent = '';
                    }
                });
            }

            // Контакты
            const contactsList = document.getElementById('contacts-list');
            if (contactsList && Array.isArray(data.contacts)) {
                contactsList.innerHTML = '';
                data.contacts.forEach(c => {
                    const li = document.createElement('li');

                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'contact-label';
                    labelSpan.textContent = c.label || '';

                    const link = document.createElement('a');
                    link.className = 'contact-link';
                    link.href = c.href || '#';
                    link.textContent = c.text || '';
                    if (c.href && /^https?:\/\//i.test(c.href)) {
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                    }

                    li.appendChild(labelSpan);
                    li.appendChild(link);
                    contactsList.appendChild(li);
                });
            }
        }

        // ====== NEWS.JSON (новости, не критично) ======
        async function loadNewsJson() {
            if (!newsContainer) return;
            try {
                const res = await fetch('content/news.json', { cache: 'no-cache' });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const items = await res.json();
                renderNews(items, newsContainer);
            } catch (err) {
                console.error('Ошибка загрузки news.json:', err);
                newsContainer.innerHTML = '<p class="news-error">Не удалось загрузить новости.</p>';
            }
        }

        function renderNews(items, container) {
            container.innerHTML = '';
            if (!Array.isArray(items) || items.length === 0) {
                container.innerHTML = '<p class="news-empty">Пока нет новостей.</p>';
                return;
            }

            items.forEach(item => {
                const article = document.createElement('article');
                article.className = 'news-item';

                const wrapperTag = (item.clickable && item.url) ? 'a' : 'div';
                const wrapper = document.createElement(wrapperTag);

                if (wrapperTag === 'a') {
                    wrapper.href = item.url;
                    wrapper.className = 'news-item-link';
                    wrapper.target = '_blank';
                    wrapper.rel = 'noopener noreferrer';
                } else {
                    wrapper.className = 'news-item-content';
                }

                if (item.date || item.dateLabel) {
                    const time = document.createElement('time');
                    time.className = 'news-date';
                    if (item.date) time.dateTime = item.date;
                    time.textContent = item.dateLabel || item.date || '';
                    wrapper.appendChild(time);
                }

                if (item.title) {
                    const h3 = document.createElement('h3');
                    h3.className = 'news-title';
                    h3.textContent = item.title;
                    wrapper.appendChild(h3);
                }

                if (item.text) {
                    const p = document.createElement('p');
                    p.className = 'news-text';
                    p.textContent = item.text;
                    wrapper.appendChild(p);
                }

                article.appendChild(wrapper);
                container.appendChild(article);
            });
        }

        // ====== GAMES.JSON + infogame.json (игры, не критично) ======
        async function loadGamesJson() {
            if (!gamesContainer) return;
            try {
                const res = await fetch('content/games.json', { cache: 'no-cache' });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const list = await res.json();
                await renderGames(list, gamesContainer);
            } catch (err) {
                console.error('Ошибка загрузки games.json:', err);
                gamesContainer.innerHTML = '<p class="games-error">Не удалось загрузить список игр.</p>';
            }
        }

        async function renderGames(list, container) {
            container.innerHTML = '';
            if (!Array.isArray(list) || list.length === 0) {
                container.innerHTML = '<p class="games-empty">Пока нет игр.</p>';
                return;
            }

            // Загружаем данные по играм параллельно
            const cardsPromises = list.map(async (item) => {
                const id = item.id;
                if (!id) return null;

                try {
                    const res = await fetch(`games/${id}/infogame.json`, { cache: 'no-cache' });
                    if (!res.ok) throw new Error('HTTP ' + res.status);
                    const game = await res.json();

                    const title = game.title || id;

                    // корректный путь к логотипу
                    let logoPath;
                    if (game.logo) {
                        if (game.logo.startsWith('http') || game.logo.startsWith('/')) {
                            logoPath = game.logo;
                        } else {
                            logoPath = `games/${id}/${game.logo}`;
                        }
                    } else {
                        logoPath = `games/${id}/logo.png`;
                    }

                    const card = document.createElement('a');
                    card.href = `games/${id}/index.html`;
                    card.target = '_blank';
                    card.rel = 'noopener noreferrer';
                    card.className = 'game-card';

                    const img = document.createElement('img');
                    img.src = logoPath;
                    img.alt = title;
                    img.className = 'game-card-logo';

                    const nameEl = document.createElement('div');
                    nameEl.className = 'game-card-title';
                    nameEl.textContent = title;

                    // флаг 18+ из infogame.json
                    const isAdult = game.adult === true || game.age18 === true || game['18plus'] === true;
                    card.dataset.adult = isAdult ? 'true' : 'false';

                    card.appendChild(img);
                    card.appendChild(nameEl);

                    return card;
                } catch (err) {
                    console.error('Ошибка загрузки игры', id, err);
                    return null;
                }
            });

            const cards = await Promise.all(cardsPromises);
            cards
                .filter(Boolean)
                .forEach(card => container.appendChild(card));

            // применяем фильтр 18+ после рендера
            applyAdultFilterToGames();
        }

        // ====== Старт: ждём JSON'ы ======
        Promise.all([
            loadContentJson(), // критичный
            loadNewsJson(),    // не критично
            loadGamesJson()    // не критично
        ])
        .then(() => {
            // Все ключевые данные загружены — убираем чёрный экран
            document.body.classList.remove('loading');
        })
        .catch((err) => {
            // Если сюда попали — не загрузился критичный контент (content.json)
            console.error('Критическая ошибка загрузки контента:', err);
            const loader = document.getElementById('app-loader');
            if (loader) {
                loader.innerHTML =
                    '<div class="loader-error">' +
                        '<p>Не удалось загрузить данные сайта.</p>' +
                        '<p>Попробуйте обновить страницу позже.</p>' +
                    '</div>';
            }
            // ВАЖНО: класс .loading НЕ убираем, чтобы не показать мусорный контент
        });
    })();
</script>
</body>
</html>
